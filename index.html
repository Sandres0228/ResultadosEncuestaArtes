<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encuesta acad√©mica ‚Äì Artes UNAL</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
/* ===== RESET Y VARIABLES ===== */
:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
    --border-color: #dee2e6;
    --border-radius: 8px;
    --shadow: 0 2px 4px rgba(0,0,0,0.08);
    --shadow-hover: 0 4px 8px rgba(0,0,0,0.12);
    --transition: all 0.2s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    line-height: 1.6;
    color: #333;
    background-color: #f5f7fa;
    -webkit-font-smoothing: antialiased;
}

/* ===== CONTENEDOR PRINCIPAL ===== */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
}

/* ===== HEADER ===== */
header {
    background: white;
    padding: 24px 16px;
    margin-bottom: 24px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    text-align: center;
}

header h1 {
    color: var(--primary-color);
    font-size: 1.75rem;
    margin-bottom: 8px;
    font-weight: 600;
}

header p {
    color: #666;
    font-size: 1rem;
}

/* ===== SECCIONES ===== */
section {
    display: none;
}

section.active {
    display: block;
}

/* ===== TARJETAS PRINCIPALES ===== */
.opciones {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
    margin-bottom: 24px;
}

@media (min-width: 768px) {
    .opciones {
        grid-template-columns: 1fr 1fr;
    }
}

.opcion {
    background: white;
    padding: 24px;
    border-radius: var(--border-radius);
    cursor: pointer;
    text-align: center;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    transition: var(--transition);
    min-height: 140px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    user-select: none;
}

.opcion:hover {
    box-shadow: var(--shadow-hover);
    border-color: var(--secondary-color);
    transform: translateY(-2px);
}

.opcion:active {
    transform: translateY(-1px);
}

.opcion .icono {
    font-size: 2.5rem;
    margin-bottom: 12px;
    display: block;
}

.opcion h2 {
    color: var(--primary-color);
    font-size: 1.25rem;
    margin-bottom: 8px;
    font-weight: 600;
}

.opcion p {
    color: #666;
    font-size: 0.9rem;
    max-width: 300px;
}

/* ===== CONTROLES ===== */
.control {
    background: white;
    padding: 16px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

.control-header {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
}

@media (min-width: 768px) {
    .control-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }
}

.btn-volver {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.95rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: var(--transition);
    width: fit-content;
    user-select: none;
}

.btn-volver:hover {
    background: #1a252f;
    transform: translateX(-2px);
}

.btn-volver:active {
    transform: translateX(-1px);
}

.buscador {
    flex: 1;
    max-width: 100%;
}

@media (min-width: 768px) {
    .buscador {
        max-width: 400px;
    }
}

.buscador input {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 0.95rem;
    transition: var(--transition);
}

.buscador input:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.filtros {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 8px;
}

.filtro-btn {
    background: #f8f9fa;
    border: 1px solid var(--border-color);
    padding: 8px 16px;
    border-radius: var(--border-radius);
    font-size: 0.85rem;
    cursor: pointer;
    white-space: nowrap;
    transition: var(--transition);
    user-select: none;
}

.filtro-btn:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.filtro-btn:active {
    transform: translateY(0);
}

.filtro-btn.active {
    background: var(--secondary-color);
    color: white;
    border-color: var(--secondary-color);
}

/* ===== LISTA DE ITEMS ===== */
.lista {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
}

@media (min-width: 640px) {
    .lista {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
}

.item {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    overflow: hidden;
    transition: var(--transition);
    min-height: 120px;
    display: flex;
    flex-direction: column;
    user-select: none;
}

.item:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
}

.item:active {
    transform: translateY(-1px);
}

.item.gris {
    background: #f8f9fa;
    border: 1px dashed #adb5bd;
}

.item.gris:hover {
    transform: none;
    box-shadow: var(--shadow);
}

.item-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    flex: 1;
}

.item strong {
    color: var(--primary-color);
    font-size: 1rem;
    font-weight: 600;
    display: block;
    margin-bottom: 8px;
    line-height: 1.4;
}

.estado {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    margin-top: 8px;
}

.item:not(.gris) .estado {
    background: #d4edda;
    color: #155724;
}

.item.gris .estado {
    background: #e2e3e5;
    color: #383d41;
}

.item-footer {
    padding: 12px 16px;
    background: #f8f9fa;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.rating-mini {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.9rem;
}

.estrellas-mini {
    color: #f5b301;
    font-size: 0.9rem;
}

.opinion-count {
    color: #666;
    font-size: 0.8rem;
}

.btn-opinar {
    background: var(--accent-color);
    color: white;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: var(--border-radius);
    font-size: 0.85rem;
    font-weight: 500;
    transition: var(--transition);
    display: inline-block;
    user-select: none;
}

.btn-opinar:hover {
    background: #c0392b;
    transform: translateY(-1px);
}

.btn-opinar:active {
    transform: translateY(0);
}

/* ===== PERFIL ===== */
.perfil {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.perfil-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.perfil-header h2 {
    font-size: 1.5rem;
    margin-bottom: 8px;
    font-weight: 600;
}

.perfil-subtitle {
    font-size: 0.95rem;
    opacity: 0.9;
}

/* ===== CALIFICACI√ìN ===== */
.calificacion {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.rating-container {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.promedio-numero {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-color);
}

.estrellas-promedio {
    font-size: 1.5rem;
    letter-spacing: 2px;
    margin-bottom: 4px;
}

.estrellas-promedio .estrella-llena {
    color: #f5b301;
}

.estrellas-promedio .estrella-vacia {
    color: #ddd;
}

.rating-info {
    flex: 1;
}

.total-opiniones {
    color: #666;
    font-size: 0.9rem;
    margin-top: 4px;
}

/* ===== INFORMACI√ìN EXTENDIDA (MATERIAS) ===== */
.info-materia {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.info-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
}

@media (min-width: 640px) {
    .info-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
}

.info-item {
    padding: 12px;
    background: #f8f9fa;
    border-radius: var(--border-radius);
    border-left: 3px solid var(--secondary-color);
}

.info-item h4 {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-item p {
    font-size: 1rem;
    color: var(--primary-color);
    font-weight: 500;
}

/* Indicadores visuales */
.indicator {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 500;
    margin: 2px;
}

.indicator.alta { background: #f8d7da; color: #721c24; }
.indicator.media { background: #fff3cd; color: #856404; }
.indicator.baja { background: #d4edda; color: #155724; }

.indicator.alto { background: #f8d7da; color: #721c24; }
.indicator.medio { background: #fff3cd; color: #856404; }
.indicator.bajo { background: #d4edda; color: #155724; }
.indicator.muy-alto { background: #dc3545; color: white; }
.indicator.casi-ninguno { background: #28a745; color: white; }

/* ===== MATERIAS ASOCIADAS (DOCENTES) ===== */
.materias-asociadas {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.materias-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
}

.materia-tag {
    background: #e7f3ff;
    color: var(--secondary-color);
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: var(--transition);
}

.materia-tag:hover {
    background: #d0e7ff;
    transform: translateY(-1px);
}

/* ===== COMENTARIOS ===== */
.comentarios-section {
    padding: 20px;
}

.comentarios-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
}

.comentarios-header h3 {
    font-size: 1.1rem;
    color: var(--primary-color);
    font-weight: 600;
}

.btn-toggle-comentarios {
    background: var(--secondary-color);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: var(--transition);
    user-select: none;
}

.btn-toggle-comentarios:hover {
    background: #2980b9;
    transform: translateY(-1px);
}

.btn-toggle-comentarios:active {
    transform: translateY(0);
}

.comentarios-container {
    display: none;
}

.comentarios-container.visible {
    display: block;
    animation: fadeIn 0.3s ease;
}

.comentario {
    background: #f8f9fa;
    padding: 16px;
    border-radius: var(--border-radius);
    margin-bottom: 12px;
    border-left: 3px solid var(--secondary-color);
    transition: var(--transition);
}

.comentario:hover {
    background: #eef5ff;
}

.comentario-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
    flex-wrap: wrap;
    gap: 8px;
}

.comentario-origen {
    background: #6c757d;
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 500;
}

.comentario-fecha {
    font-size: 0.8rem;
    color: #666;
}

.comentario-texto {
    font-size: 0.95rem;
    line-height: 1.5;
    color: #333;
}

/* ===== SIN DATOS ===== */
.sin-datos {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.sin-datos .icono {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.3;
}

.sin-datos h3 {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: #495057;
}

.sin-datos p {
    max-width: 400px;
    margin: 0 auto;
    font-size: 0.95rem;
}

/* ===== LOADING ===== */
.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.loading-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--secondary-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ===== ESTAD√çSTICAS ===== */
.estadisticas {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 24px;
    border: 1px solid var(--border-color);
}

.estadisticas h3 {
    font-size: 1.1rem;
    color: var(--primary-color);
    margin-bottom: 16px;
    font-weight: 600;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
}

.stat-item {
    text-align: center;
    padding: 16px;
    background: #f8f9fa;
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
    transition: var(--transition);
}

.stat-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 0.85rem;
    color: #666;
}

/* ===== FOOTER ===== */
footer {
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 0.85rem;
    margin-top: 40px;
    border-top: 1px solid var(--border-color);
}
</style>
</head>

<body>

<div class="container">
    <header>
        <h1>üé® Encuesta acad√©mica ‚Äì Artes UNAL</h1>
        <p>Resultados sobre asignaturas y docentes</p>
    </header>

    <main>
        <!-- SECCI√ìN INICIO -->
        <section id="inicio" class="active">
            <div class="opciones">
                <div class="opcion" onclick="verAsignaturas()">
                    <span class="icono">üìò</span>
                    <h2>Asignaturas</h2>
                    <p>Calificaciones, enfoque, carga acad√©mica y gasto econ√≥mico</p>
                </div>
                <div class="opcion" onclick="verDocentes()">
                    <span class="icono">üë©‚Äçüè´</span>
                    <h2>Docentes</h2>
                    <p>Evaluaciones y materias asociadas a cada profesor</p>
                </div>
            </div>
            <div class="formulario-access" style="margin: 20px 0; text-align: center;">
    <a href="https://sandres0228.github.io/Opinionmaterias-Artesunalmed/" 
       target="_blank" 
       class="btn-formulario"
       style="display: inline-flex;
              align-items: center;
              gap: 10px;
              padding: 14px 24px;
              background: linear-gradient(135deg, #4CAF50, #45a049);
              color: white;
              text-decoration: none;
              border-radius: 8px;
              font-weight: 600;
              font-size: 1.1rem;
              box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
              transition: all 0.3s ease;
              border: none;
              cursor: pointer;">
        <i class="fas fa-edit" style="font-size: 1.2rem;"></i>
        üìù Llenar formulario de opinion de asignaturas
    </a>
    
    <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
        ¬°Tu opini√≥n ayuda a otros estudiantes a elegir mejor!
    </p>
</div>
            
            <div class="estadisticas" id="estadisticas">
                <h3>üìä Estad√≠sticas generales</h3>
                <div class="stats-grid" id="stats-container">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </section>

        <!-- SECCI√ìN LISTADO -->
        <section id="listado">
            <div class="control">
                <div class="control-header">
                    <button class="btn-volver" onclick="volver()">
                        ‚Üê Volver al inicio
                    </button>
                    <div class="buscador">
                        <input id="buscar" placeholder="Buscar por nombre..." oninput="filtrar()">
                    </div>
                </div>
                <div class="filtros" id="filtros">
                    <!-- Filtros din√°micos -->
                </div>
            </div>
            <div class="lista" id="lista"></div>
        </section>

        <!-- SECCI√ìN PERFIL -->
        <section id="perfil">
            <div class="control">
                <button class="btn-volver" onclick="volverPerfil()">
                    ‚Üê Volver al listado
                </button>
            </div>
            <div id="contenidoPerfil"></div>
        </section>
    </main>

    <footer>
        <p>Encuesta acad√©mica ‚Äì Facultad de Artes UNAL ‚Ä¢ Datos actualizados autom√°ticamente</p>
    </footer>
</div>

<script>
// ================= CONFIGURACI√ìN =================
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR5wz3oj529qZ4Zo-fp_55EAhmqVp9EJJHIo99cOD62gRwPWbjaXRN_NA7lR-th6umwqdm0S48IwE7d/pub?output=csv";

// Lista completa de asignaturas (sin Talleres)
const ASIGNATURAS_BASE = [
    "Aproximaci√≥n a los procesos cer√°micos (3010611)",
    "Arte y archivo (3009874)",
    "Arte y ciudad (3010614)",
    "Arte y documento (3009875)",
    "B√°sico espacio I (3009837)",
    "B√°sico espacio II (3009838)",
    "B√°sico imagen I (3010734)",
    "B√°sico imagen II (3010735)",
    "Herramientas digitales I (3009879)",
    "Herramientas digitales II (3009880)",
    "Historia del arte I (3006669)",
    "Historia del arte II (3010698)",
    "Historia del arte III (3006671)",
    "Historia del performance I (3010609)",
    "Historia del performance II (3010608)",
    "Instalaciones e intervenciones (3010629)",
    "Laboratorio de dibujo I (3009841)",
    "Laboratorio de dibujo II (3009842)",
    "Laboratorio de escultura I (3009843)",
    "Laboratorio de escultura II (3009844)",
    "Laboratorio de fotograf√≠a I (3010736)",
    "Laboratorio de fotograf√≠a II (3010737)",
    "Laboratorio de gr√°fica I (3006683)",
    "Laboratorio de gr√°fica II (3009882)",
    "Laboratorio de medios no tradicionales (3009885)",
    "Laboratorio de pintura I (3009848)",
    "Laboratorio de pintura II (3009849)",
    "Laboratorio de t√©cnicas gr√°ficas (3009887)",
    "Laboratorio de t√©cnicas pict√≥ricas (3009888)",
    "Laboratorio de video I (3009850)",
    "Laboratorio de video II (3009851)",
    "Pr√°cticas art√≠sticas contempor√°neas en Colombia (3010636)",
    "Pr√°cticas art√≠sticas I (3009852)",
    "Pr√°cticas art√≠sticas II (3009853)",
    "Realizaci√≥n documental (3009892)",
    "Seminario de investigaci√≥n I (3009855)",
    "Seminario de investigaci√≥n II (3009856)",
    "Seminario I (3009854)",
    "Seminario II (3006700)",
    "Seminario III (3006701)"
    // Talleres eliminados intencionalmente
];

// Lista de docentes
const DOCENTES_BASE = [
    "Camilo Rodr√≠guez Castro",
    "Carolina V√©lez Luj√°n",
    "Catalina del Roc√≠o Rojas Casallas",
    "Daniela Serna Gallego",
    "Edna Yulieth Sierra Duque",
    "Fernando Celimo Escobar Neira",
    "Sandra Carolina Chac√≥n Bernal",
    "Hebert Rodr√≠guez Garc√≠a",
    "Jairo Augusto Sol√≥rzano Ariza",
    "Jorge Alberto Rodr√≠guez Salazarriaga",
    "Jorge Andr√©s Mar√≠n V√°squez",
    "Juan Guillermo Caicedo",
    "Luis Eduardo Serna",
    "Mar√≠a Ang√©lica Teuta Echeverri",
    "Mar√≠a Isabel Naranjo Cano",
    "Miguel √Ångel Flores Santander",
    "Nadia Ximena Lorena Moreno",
    "Natalia Echeverri Arango",
    "Natalia Isabel P√©rez Villegas",
    "Natalia Restrepo Restrepo",
    "√ìscar Mauricio Ardila Luna",
    "Paula Marcela Restrepo Cardona",
    "Paulina Escobar Aguirre",
    "Pedro Antonio Agudelo Rend√≥n",
    "Sebasti√°n Alexi Wiedemann",
    "V√©ronique Marie Christine Mondejar"
];

// Variables globales
let datos = [];
let vista = "";
let listaActual = [];
let filtroActual = "todos";
let debounceTimeout;
let estadisticasGenerales = null;

// Regex para identificar talleres
const TALLERES_REGEX = /Taller (II|III|IV|V|VI|VII)(?!\w)/i;

// ================= UTILIDADES =================
function escapeHTML(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function normalizar(texto) {
    if (!texto) return '';
    return texto.toString().toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "");
}

function calcularPromedio(arr) {
    if (!arr || arr.length === 0) return 0;
    const validos = arr.filter(n => !isNaN(n) && n > 0);
    if (validos.length === 0) return 0;
    const suma = validos.reduce((a, b) => a + b, 0);
    return Math.round((suma / validos.length) * 10) / 10;
}

function generarEstrellas(promedio) {
    const estrellasLlenas = Math.floor(promedio);
    const tieneMedia = promedio % 1 >= 0.3 && promedio % 1 <= 0.7;
    const estrellasHTML = [];
    
    for (let i = 1; i <= 5; i++) {
        if (i <= estrellasLlenas) {
            estrellasHTML.push('<span class="estrella-llena">‚òÖ</span>');
        } else if (i === estrellasLlenas + 1 && tieneMedia) {
            estrellasHTML.push('<span class="estrella-llena" style="opacity:0.7">‚òÖ</span>');
        } else {
            estrellasHTML.push('<span class="estrella-vacia">‚òÜ</span>');
        }
    }
    
    return estrellasHTML.join('');
}

function esTaller(asignatura) {
    return TALLERES_REGEX.test(asignatura);
}

// ================= ALGORITMO PARA CALCULAR MODA (VALOR M√ÅS FRECUENTE) =================
function calcularModa(valores) {
    if (!valores || valores.length === 0) return "No especificado";
    
    // Filtrar valores vac√≠os
    const valoresFiltrados = valores.filter(v => v && v.trim() && v !== "No especificado");
    if (valoresFiltrados.length === 0) return "No especificado";
    
    // Contar frecuencia de cada valor
    const frecuencia = {};
    valoresFiltrados.forEach(valor => {
        const val = valor.trim();
        frecuencia[val] = (frecuencia[val] || 0) + 1;
    });
    
    // Encontrar el valor con mayor frecuencia
    let moda = "";
    let maxFrecuencia = 0;
    
    Object.entries(frecuencia).forEach(([valor, count]) => {
        if (count > maxFrecuencia) {
            maxFrecuencia = count;
            moda = valor;
        } else if (count === maxFrecuencia) {
            // En caso de empate, seleccionar seg√∫n criterios espec√≠ficos
            moda = resolverEmpate(moda, valor);
        }
    });
    
    return moda || "No especificado";
}

function resolverEmpate(valor1, valor2) {
    // Orden de preferencia para Carga Acad√©mica
    const ordenCarga = { "Baja": 1, "Media": 2, "Alta": 3 };
    
    // Orden de preferencia para Gasto Econ√≥mico (de menor a mayor)
    const ordenGasto = { 
        "Casi ninguno": 1, 
        "Bajo": 2, 
        "Medio": 3, 
        "Alto": 4, 
        "Muy alto": 5 
    };
    
    // Verificar si son valores de carga acad√©mica
    if (valor1 in ordenCarga && valor2 in ordenCarga) {
        return ordenCarga[valor1] > ordenCarga[valor2] ? valor1 : valor2;
    }
    
    // Verificar si son valores de gasto econ√≥mico
    if (valor1 in ordenGasto && valor2 in ordenGasto) {
        // Para gasto, preferir el valor m√°s conservador (menor)
        return ordenGasto[valor1] < ordenGasto[valor2] ? valor1 : valor2;
    }
    
    // Si no son comparables, mantener el primero
    return valor1;
}

// ================= C√ÅLCULO DE RANKING INTELIGENTE =================
function calcularRanking(promedio, numOpiniones) {
    // F√≥rmula que balancea promedio y cantidad de opiniones
    // Penaliza items con pocas opiniones
    const minOpiniones = 3;
    
    if (numOpiniones < minOpiniones) {
        // Penalizaci√≥n fuerte para pocas opiniones
        return promedio * (numOpiniones / minOpiniones);
    }
    
    // Bonificaci√≥n para muchas opiniones (hasta 2x)
    const pesoOpiniones = Math.min(numOpiniones / minOpiniones, 2);
    return promedio * pesoOpiniones;
}

// ================= CARGA Y PROCESAMIENTO DE DATOS =================
function cargarDatos() {
    Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(resultado) {
            datos = resultado.data.map(fila => {
                const limpia = {};
                Object.keys(fila).forEach(clave => {
                    limpia[clave.trim()] = fila[clave] ? fila[clave].toString().trim() : '';
                });
                return limpia;
            });
            
            // üîç DEBUGGING: Mostrar nombres de columnas para verificar
            if (datos.length > 0) {
                console.log("üìä Nombres de columnas en CSV:", Object.keys(datos[0] || {}));
                console.log("üìÑ Primer registro completo:", datos[0]);
                
                // Buscar columnas relacionadas con carga y gasto
                const primerRegistro = datos[0];
                console.log("üîç Buscando columnas relacionadas:");
                Object.keys(primerRegistro).forEach(key => {
                    if (key.toLowerCase().includes('carga') || 
                        key.toLowerCase().includes('gasto') ||
                        key.toLowerCase().includes('econ') ||
                        key.toLowerCase().includes('acad')) {
                        console.log(`‚úÖ Encontrada columna: "${key}" = "${primerRegistro[key]}"`);
                    }
                });
            }
            
            console.log(`‚úÖ Datos cargados: ${datos.length} registros`);
            calcularEstadisticas();
            actualizarEstadisticasUI();
        },
        error: function(error) {
            console.error('‚ùå Error cargando datos:', error);
            mostrarError('Error al cargar los datos. Por favor, recarga la p√°gina.');
        }
    });
}

function calcularEstadisticas() {
    // Calificaciones de asignaturas (excluyendo talleres)
    const califAsignaturas = [];
    const asignaturasVistas = new Set();
    
    // Calificaciones de docentes
    const califDocentes = [];
    const docentesVistos = new Set();
    
    // Conteo de opiniones
    let totalOpinionesAsignaturas = 0;
    let totalOpinionesDocentes = 0;
    
    datos.forEach(fila => {
        const asignatura = fila.Asignatura;
        const docente = fila.Docente;
        
        // Calificaci√≥n de asignatura (si no es taller)
        if (asignatura && !esTaller(asignatura)) {
            const calif = parseFloat(fila["Valoraci√≥n materia"]);
            if (!isNaN(calif) && calif > 0) {
                califAsignaturas.push(calif);
                asignaturasVistas.add(asignatura);
                totalOpinionesAsignaturas++;
            }
        }
        
        // Calificaci√≥n de docente
        if (docente) {
            const calif = parseFloat(fila["Valoraci√≥n Docente"]);
            if (!isNaN(calif) && calif > 0) {
                califDocentes.push(calif);
                docentesVistos.add(docente);
                totalOpinionesDocentes++;
            }
        }
    });
    
    estadisticasGenerales = {
        promedioAsignaturas: calcularPromedio(califAsignaturas),
        promedioDocentes: calcularPromedio(califDocentes),
        totalAsignaturasConOpiniones: asignaturasVistas.size,
        totalDocentesConOpiniones: docentesVistos.size,
        totalOpinionesAsignaturas: totalOpinionesAsignaturas,
        totalOpinionesDocentes: totalOpinionesDocentes,
        asignaturasAnalizadas: Array.from(asignaturasVistas),
        docentesAnalizados: Array.from(docentesVistos)
    };
}

function actualizarEstadisticasUI() {
    if (!estadisticasGenerales) return;
    
    const container = document.getElementById('stats-container');
    container.innerHTML = `
        <div class="stat-item">
            <div class="stat-value">${estadisticasGenerales.promedioAsignaturas.toFixed(1)}</div>
            <div class="stat-label">‚≠ê Prom. Asignaturas</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${estadisticasGenerales.promedioDocentes.toFixed(1)}</div>
            <div class="stat-label">‚≠ê Prom. Docentes</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${estadisticasGenerales.totalAsignaturasConOpiniones}</div>
            <div class="stat-label">üìö Asignaturas evaluadas</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${estadisticasGenerales.totalOpinionesAsignaturas + estadisticasGenerales.totalOpinionesDocentes}</div>
            <div class="stat-label">üí¨ Opiniones totales</div>
        </div>
    `;
}

// ================= GESTI√ìN DE VISTAS =================
function mostrarSeccion(id) {
    document.querySelectorAll('section').forEach(seccion => {
        seccion.classList.remove('active');
    });
    document.getElementById(id).classList.add('active');
}

function verAsignaturas() {
    vista = "asignatura";
    filtroActual = "todos"; // Por defecto mostrar todas en orden alfab√©tico
    mostrarSeccion('listado');
    actualizarFiltros();
    cargarListaAsignaturas();
}

function verDocentes() {
    vista = "docente";
    filtroActual = "todos"; // Por defecto mostrar todos en orden alfab√©tico
    mostrarSeccion('listado');
    actualizarFiltros();
    cargarListaDocentes();
}

function volver() {
    mostrarSeccion('inicio');
}

function volverPerfil() {
    mostrarSeccion('listado');
}

// ================= FILTROS =================
function actualizarFiltros() {
    const container = document.getElementById('filtros');
    let filtrosHTML = '';
    
    if (vista === "asignatura") {
        filtrosHTML = `
            <button class="filtro-btn ${filtroActual === 'todos' ? 'active' : ''}" onclick="cambiarFiltro('todos')">
                Todas (A-Z)
            </button>
            <button class="filtro-btn ${filtroActual === 'mejores' ? 'active' : ''}" onclick="cambiarFiltro('mejores')">
                ‚≠ê Mejor calificadas
            </button>
            <button class="filtro-btn ${filtroActual === 'teoricas' ? 'active' : ''}" onclick="cambiarFiltro('teoricas')">
                üìö Te√≥ricas
            </button>
            <button class="filtro-btn ${filtroActual === 'tecnicas' ? 'active' : ''}" onclick="cambiarFiltro('tecnicas')">
                üîß T√©cnicas
            </button>
            <!-- NUEVOS FILTROS PARA CARGA Y GASTO -->
            <button class="filtro-btn ${filtroActual === 'carga-baja' ? 'active' : ''}" onclick="cambiarFiltro('carga-baja')">
                ‚öñÔ∏è Carga Baja
            </button>
            <button class="filtro-btn ${filtroActual === 'gasto-bajo' ? 'active' : ''}" onclick="cambiarFiltro('gasto-bajo')">
                üí∞ Gasto Bajo
            </button>
        `;
    } else {
        filtrosHTML = `
            <button class="filtro-btn ${filtroActual === 'todos' ? 'active' : ''}" onclick="cambiarFiltro('todos')">
                Todos (A-Z)
            </button>
            <button class="filtro-btn ${filtroActual === 'mejores' ? 'active' : ''}" onclick="cambiarFiltro('mejores')">
                ‚≠ê Mejor calificados
            </button>
            <button class="filtro-btn ${filtroActual === 'conOpiniones' ? 'active' : ''}" onclick="cambiarFiltro('conOpiniones')">
                üí¨ Con opiniones
            </button>
        `;
    }
    
    container.innerHTML = filtrosHTML;
}

function cambiarFiltro(tipo) {
    filtroActual = tipo;
    actualizarFiltros();
    
    if (vista === "asignatura") {
        cargarListaAsignaturas();
    } else {
        cargarListaDocentes();
    }
}

// ================= CARGA DE LISTAS =================
function cargarListaAsignaturas() {
    // Obtener todas las asignaturas con sus datos procesados
    const asignaturasConDatos = [];
    
    ASIGNATURAS_BASE.forEach(asignaturaNombre => {
        const registros = datos.filter(fila => 
            fila.Asignatura && normalizar(fila.Asignatura) === normalizar(asignaturaNombre)
        );
        
        // Calificaciones de la materia
        const calificaciones = registros
            .map(fila => parseFloat(fila["Valoraci√≥n materia"]))
            .filter(calif => !isNaN(calif) && calif > 0);
        
        // Recopilar TODOS los valores para cada campo - CORREGIDO CON NOMBRES CORRECTOS
        const todosEnfoques = registros
            .map(fila => fila.Enfoque)
            .filter(enfoque => enfoque && enfoque.trim());
        
        // ‚úÖ CORRECCI√ìN CR√çTICA AQU√ç: Nombres CORRECTOS de columnas
        const todasCargas = registros
            .map(fila => fila["Carga Acad√©mica"])  // ‚Üê NOMBRE CORRECTO
            .filter(carga => carga && carga.trim());
        
        const todosGastos = registros
            .map(fila => fila["Gasto Econ√≥mico"])  // ‚Üê NOMBRE CORRECTO
            .filter(gasto => gasto && gasto.trim());
        
        const todosTiposEvaluacion = registros
            .map(fila => fila.Calificaci√≥n)
            .filter(tipo => tipo && tipo.trim());
        
        // Calcular la moda (valor m√°s frecuente) para cada campo
        const infoExtendida = {
            enfoque: calcularModa(todosEnfoques),
            carga: calcularModa(todasCargas),
            gasto: calcularModa(todosGastos),
            tipoEvaluacion: calcularModa(todosTiposEvaluacion)
        };
        
        const promedio = calcularPromedio(calificaciones);
        const numOpiniones = calificaciones.length;
        const ranking = calcularRanking(promedio, numOpiniones);
        
        asignaturasConDatos.push({
            nombre: asignaturaNombre,
            promedio: promedio,
            numOpiniones: numOpiniones,
            ranking: ranking,
            tieneOpiniones: numOpiniones > 0,
            infoExtendida: infoExtendida
        });
    });
    
    // Aplicar filtros y ordenamiento
    let asignaturasFiltradas = [...asignaturasConDatos];
    
    switch (filtroActual) {
        case 'mejores':
            // Filtro inteligente: m√≠nimo 3 opiniones y ranking alto
            asignaturasFiltradas = asignaturasConDatos
                .filter(a => a.numOpiniones >= 3 && a.promedio >= 3.5)
                .sort((a, b) => b.ranking - a.ranking);
            break;
            
        case 'teoricas':
            asignaturasFiltradas = asignaturasConDatos
                .filter(a => a.infoExtendida.enfoque.toLowerCase().includes('te√≥rica'))
                .sort((a, b) => a.nombre.localeCompare(b.nombre));
            break;
            
        case 'tecnicas':
            asignaturasFiltradas = asignaturasConDatos
                .filter(a => a.infoExtendida.enfoque.toLowerCase().includes('t√©cnica'))
                .sort((a, b) => a.nombre.localeCompare(b.nombre));
            break;
            
        case 'carga-baja':
            // NUEVO FILTRO: Materias con carga acad√©mica baja
            asignaturasFiltradas = asignaturasConDatos
                .filter(a => a.infoExtendida.carga === "Baja")
                .sort((a, b) => a.nombre.localeCompare(b.nombre));
            break;
            
        case 'gasto-bajo':
            // NUEVO FILTRO: Materias con gasto econ√≥mico bajo
            asignaturasFiltradas = asignaturasConDatos
                .filter(a => a.infoExtendida.gasto === "Bajo" || a.infoExtendida.gasto === "Casi ninguno")
                .sort((a, b) => a.nombre.localeCompare(b.nombre));
            break;
            
        case 'todos':
        default:
            // Orden alfab√©tico por defecto
            asignaturasFiltradas.sort((a, b) => a.nombre.localeCompare(b.nombre));
            break;
    }
    
    mostrarListaAsignaturas(asignaturasFiltradas);
}

function cargarListaDocentes() {
    const docentesConDatos = [];
    
    DOCENTES_BASE.forEach(docenteNombre => {
        const registros = datos.filter(fila => 
            fila.Docente && normalizar(fila.Docente) === normalizar(docenteNombre)
        );
        
        // Calificaciones del docente (incluyendo talleres)
        const calificaciones = registros
            .map(fila => parseFloat(fila["Valoraci√≥n Docente"]))
            .filter(calif => !isNaN(calif) && calif > 0);
        
        // Materias asociadas (excluyendo talleres y duplicados)
        const materiasAsociadas = [...new Set(registros
            .map(fila => fila.Asignatura)
            .filter(asignatura => asignatura && !esTaller(asignatura))
        )];
        
        // Comentarios del docente
        const comentarios = registros
            .filter(fila => fila["Opini√≥n Docente"] && fila["Opini√≥n Docente"].trim())
            .map(fila => ({
                texto: fila["Opini√≥n Docente"],
                fecha: fila.Timestamp || '',
                origen: fila.Asignatura || ''
            }));
        
        const promedio = calcularPromedio(calificaciones);
        const numOpiniones = calificaciones.length;
        const ranking = calcularRanking(promedio, numOpiniones);
        
        docentesConDatos.push({
            nombre: docenteNombre,
            promedio: promedio,
            numOpiniones: numOpiniones,
            ranking: ranking,
            tieneOpiniones: numOpiniones > 0,
            materiasAsociadas: materiasAsociadas,
            comentarios: comentarios
        });
    });
    
    // Aplicar filtros y ordenamiento
    let docentesFiltrados = [...docentesConDatos];
    
    switch (filtroActual) {
        case 'mejores':
            // Filtro inteligente para docentes
            docentesFiltrados = docentesConDatos
                .filter(d => d.numOpiniones >= 2 && d.promedio >= 3.5)
                .sort((a, b) => b.ranking - a.ranking);
            break;
            
        case 'conOpiniones':
            docentesFiltrados = docentesConDatos
                .filter(d => d.tieneOpiniones)
                .sort((a, b) => a.nombre.localeCompare(b.nombre));
            break;
            
        case 'todos':
        default:
            // Orden alfab√©tico por defecto
            docentesFiltrados.sort((a, b) => a.nombre.localeCompare(b.nombre));
            break;
    }
    
    mostrarListaDocentes(docentesFiltrados);
}

// ================= MOSTRAR LISTAS =================
function mostrarListaAsignaturas(asignaturas) {
    const container = document.getElementById('lista');
    
    if (asignaturas.length === 0) {
        container.innerHTML = `
            <div class="sin-datos">
                <div class="icono">üìö</div>
                <h3>No hay asignaturas que coincidan</h3>
                <p>Intenta con otro filtro o t√©rmino de b√∫squeda</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    asignaturas.forEach(asignatura => {
        const tieneOpiniones = asignatura.tieneOpiniones;
        const claseItem = `item${tieneOpiniones ? '' : ' gris'}`;
        const tieneInteraccion = tieneOpiniones ? 'cursor: pointer;' : '';
        
        // Funci√≥n para determinar la clase CSS seg√∫n carga/gasto
        const getBadgeClass = (valor) => {
            if (!valor || valor === "No especificado") return "";
            
            if (["Baja", "Media", "Alta"].includes(valor)) {
                return `badge-carga-${valor.toLowerCase()}`;
            }
            
            if (["Casi ninguno", "Bajo", "Medio", "Alto", "Muy alto"].includes(valor)) {
                const nombreClase = valor.toLowerCase().replace(" ", "-").replace("casi-ninguno", "gasto-ninguno");
                return `badge-gasto-${nombreClase}`;
            }
            
            return "";
        };
        
        html += `
            <div class="${claseItem}" ${tieneOpiniones ? `onclick="verPerfilAsignatura('${escapeHTML(asignatura.nombre)}')"` : ''} style="${tieneInteraccion}">
                <div class="item-header">
                    <strong>${escapeHTML(asignatura.nombre)}</strong>
                    
                    ${asignatura.infoExtendida.enfoque !== "No especificado" ? `
                        <div style="margin-top: 8px; font-size: 0.85rem; color: #666;">
                            üìù ${escapeHTML(asignatura.infoExtendida.enfoque)}
                        </div>
                    ` : ''}
                    
                    <!-- NUEVO: Mostrar carga y gasto con badges -->
                    ${asignatura.infoExtendida.carga !== "No especificado" ? `
                        <div style="margin-top: 4px; font-size: 0.8rem;">
                            <span class="${getBadgeClass(asignatura.infoExtendida.carga)}" style="padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">
                                ‚öñÔ∏è ${escapeHTML(asignatura.infoExtendida.carga)}
                            </span>
                        </div>
                    ` : ''}
                    
                    ${asignatura.infoExtendida.gasto !== "No especificado" ? `
                        <div style="margin-top: 4px; font-size: 0.8rem;">
                            <span class="${getBadgeClass(asignatura.infoExtendida.gasto)}" style="padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">
                                üí∞ ${escapeHTML(asignatura.infoExtendida.gasto)}
                            </span>
                        </div>
                    ` : ''}
                    
                    <div class="estado">
                        ${tieneOpiniones ? `${asignatura.numOpiniones} ${asignatura.numOpiniones === 1 ? 'opini√≥n' : 'opiniones'}` : 'Sin opiniones a√∫n'}
                    </div>
                </div>
                
                <div class="item-footer">
                    ${tieneOpiniones ? `
                        <div class="rating-mini">
                            <span class="estrellas-mini">${generarEstrellas(asignatura.promedio)}</span>
                            <span class="opinion-count">${asignatura.promedio.toFixed(1)}/5</span>
                        </div>
                    ` : `
                        <div class="rating-mini">
                            <span style="color: #999; font-size: 0.85rem;">Sin calificaciones</span>
                        </div>
                    `}
                    
                    ${!tieneOpiniones ? `
                        <a class="btn-opinar" target="_blank" 
                           href="https://sandres0228.github.io/Opinionmaterias-Artesunalmed/">
                           Opinar ahora
                        </a>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function mostrarListaDocentes(docentes) {
    const container = document.getElementById('lista');
    
    if (docentes.length === 0) {
        container.innerHTML = `
            <div class="sin-datos">
                <div class="icono">üë§</div>
                <h3>No hay docentes que coincidan</h3>
                <p>Intenta con otro filtro o t√©rmino de b√∫squeda</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    docentes.forEach(docente => {
        const tieneOpiniones = docente.tieneOpiniones;
        const claseItem = `item${tieneOpiniones ? '' : ' gris'}`;
        const tieneInteraccion = tieneOpiniones ? 'cursor: pointer;' : '';
        
        html += `
            <div class="${claseItem}" ${tieneOpiniones ? `onclick="verPerfilDocente('${escapeHTML(docente.nombre)}')"` : ''} style="${tieneInteraccion}">
                <div class="item-header">
                    <strong>${escapeHTML(docente.nombre)}</strong>
                    
                    ${docente.materiasAsociadas.length > 0 ? `
                        <div style="margin-top: 8px; font-size: 0.85rem; color: #666;">
                            üìö ${docente.materiasAsociadas.length} ${docente.materiasAsociadas.length === 1 ? 'materia' : 'materias'} asociadas
                        </div>
                    ` : ''}
                    
                    <div class="estado">
                        ${tieneOpiniones ? `${docente.numOpiniones} ${docente.numOpiniones === 1 ? 'evaluaci√≥n' : 'evaluaciones'}` : 'Sin evaluaciones a√∫n'}
                    </div>
                </div>
                
                <div class="item-footer">
                    ${tieneOpiniones ? `
                        <div class="rating-mini">
                            <span class="estrellas-mini">${generarEstrellas(docente.promedio)}</span>
                            <span class="opinion-count">${docente.promedio.toFixed(1)}/5</span>
                        </div>
                    ` : `
                        <div class="rating-mini">
                            <span style="color: #999; font-size: 0.85rem;">Sin calificaciones</span>
                        </div>
                    `}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ================= B√öSQUEDA =================
function filtrar() {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
        const query = normalizar(document.getElementById('buscar').value);
        
        if (!query) {
            if (vista === 'asignatura') {
                cargarListaAsignaturas();
            } else {
                cargarListaDocentes();
            }
            return;
        }
        
        // Filtrar seg√∫n la vista actual
        if (vista === 'asignatura') {
            const asignaturasFiltradas = ASIGNATURAS_BASE
                .filter(asignatura => normalizar(asignatura).includes(query))
                .map(nombre => {
                    const registros = datos.filter(fila => 
                        fila.Asignatura && normalizar(fila.Asignatura) === normalizar(nombre)
                    );
                    
                    const calificaciones = registros
                        .map(fila => parseFloat(fila["Valoraci√≥n materia"]))
                        .filter(calif => !isNaN(calif) && calif > 0);
                    
                    // Calcular info extendida para la b√∫squeda - CORREGIDO
                    const todosEnfoques = registros
                        .map(fila => fila.Enfoque)
                        .filter(enfoque => enfoque && enfoque.trim());
                    
                    const todasCargas = registros
                        .map(fila => fila["Carga Acad√©mica"])  // ‚Üê CORREGIDO
                        .filter(carga => carga && carga.trim());
                    
                    const todosGastos = registros
                        .map(fila => fila["Gasto Econ√≥mico"])  // ‚Üê CORREGIDO
                        .filter(gasto => gasto && gasto.trim());
                    
                    return {
                        nombre: nombre,
                        promedio: calcularPromedio(calificaciones),
                        numOpiniones: calificaciones.length,
                        tieneOpiniones: calificaciones.length > 0,
                        infoExtendida: {
                            enfoque: calcularModa(todosEnfoques),
                            carga: calcularModa(todasCargas),
                            gasto: calcularModa(todosGastos)
                        }
                    };
                });
            
            mostrarListaAsignaturas(asignaturasFiltradas);
        } else {
            const docentesFiltrados = DOCENTES_BASE
                .filter(docente => normalizar(docente).includes(query))
                .map(nombre => {
                    const registros = datos.filter(fila => 
                        fila.Docente && normalizar(fila.Docente) === normalizar(nombre)
                    );
                    
                    const calificaciones = registros
                        .map(fila => parseFloat(fila["Valoraci√≥n Docente"]))
                        .filter(calif => !isNaN(calif) && calif > 0);
                    
                    // Materias asociadas
                    const materiasAsociadas = [...new Set(registros
                        .map(fila => fila.Asignatura)
                        .filter(asignatura => asignatura && !esTaller(asignatura))
                    )];
                    
                    return {
                        nombre: nombre,
                        promedio: calcularPromedio(calificaciones),
                        numOpiniones: calificaciones.length,
                        tieneOpiniones: calificaciones.length > 0,
                        materiasAsociadas: materiasAsociadas
                    };
                });
            
            mostrarListaDocentes(docentesFiltrados);
        }
    }, 300);
}

// ================= PERFILES =================
function verPerfilAsignatura(nombreAsignatura) {
    vista = "asignatura";
    mostrarSeccion('perfil');
    
    // Buscar todos los registros de esta asignatura
    const registros = datos.filter(fila => 
        fila.Asignatura && normalizar(fila.Asignatura) === normalizar(nombreAsignatura)
    );
    
    // Calificaciones
    const calificaciones = registros
        .map(fila => parseFloat(fila["Valoraci√≥n materia"]))
        .filter(calif => !isNaN(calif) && calif > 0);
    
    // Recopilar TODOS los valores para calcular modas - CORREGIDO
    const todosEnfoques = registros
        .map(fila => fila.Enfoque)
        .filter(enfoque => enfoque && enfoque.trim());
    
    // ‚úÖ CORRECCI√ìN CR√çTICA AQU√ç: Nombres CORRECTOS de columnas
    const todasCargas = registros
        .map(fila => fila["Carga Acad√©mica"])  // ‚Üê NOMBRE CORRECTO
        .filter(carga => carga && carga.trim());
    
    const todosGastos = registros
        .map(fila => fila["Gasto Econ√≥mico"])  // ‚Üê NOMBRE CORRECTO
        .filter(gasto => gasto && gasto.trim());
    
    const todosTiposEvaluacion = registros
        .map(fila => fila.Calificaci√≥n)
        .filter(tipo => tipo && tipo.trim());
    
    // Calcular modas
    const infoExtendida = {
        enfoque: calcularModa(todosEnfoques),
        carga: calcularModa(todasCargas),
        gasto: calcularModa(todosGastos),
        tipoEvaluacion: calcularModa(todosTiposEvaluacion),
        totalOpiniones: registros.length
    };
    
    // Comentarios
    const comentarios = registros
        .filter(fila => fila["Opini√≥n materia"] && fila["Opini√≥n materia"].trim())
        .map(fila => ({
            texto: fila["Opini√≥n materia"],
            fecha: fila.Timestamp || '',
            tipo: 'asignatura'
        }));
    
    const promedio = calcularPromedio(calificaciones);
    const numOpiniones = calificaciones.length;
    
    // Funci√≥n para determinar la clase CSS seg√∫n carga/gasto
    const getIndicatorClass = (valor) => {
        if (!valor || valor === "No especificado") return "indicator-no-especificado";
        
        if (["Baja", "Media", "Alta"].includes(valor)) {
            return `indicator-carga-${valor.toLowerCase()}`;
        }
        
        if (["Casi ninguno", "Bajo", "Medio", "Alto", "Muy alto"].includes(valor)) {
            const nombreClase = valor.toLowerCase().replace(" ", "-").replace("casi-ninguno", "gasto-ninguno");
            return `indicator-gasto-${nombreClase}`;
        }
        
        return "";
    };
    
    // Generar HTML del perfil
    let html = `
        <div class="perfil">
            <div class="perfil-header">
                <h2>üìö ${escapeHTML(nombreAsignatura)}</h2>
                <div class="perfil-subtitle">Asignatura ‚Ä¢ ${numOpiniones} ${numOpiniones === 1 ? 'opini√≥n registrada' : 'opiniones registradas'}</div>
            </div>
            
            <div class="calificacion">
                <div class="rating-container">
                    <div class="promedio-numero">${promedio.toFixed(1)}</div>
                    <div class="rating-info">
                        <div class="estrellas-promedio">
                            ${generarEstrellas(promedio)}
                        </div>
                        <div class="total-opiniones">
                            Basado en ${numOpiniones} ${numOpiniones === 1 ? 'evaluaci√≥n' : 'evaluaciones'} de ${infoExtendida.totalOpiniones} registros
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-materia">
                <h3 style="margin-bottom: 16px; color: var(--primary-color); font-size: 1.1rem;">üìã Informaci√≥n seg√∫n opiniones de estudiantes</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <h4>Enfoque</h4>
                        <p>${escapeHTML(infoExtendida.enfoque)}</p>
                    </div>
                    <div class="info-item">
                        <h4>Carga Acad√©mica</h4>
                        <p>
                            <span class="${getIndicatorClass(infoExtendida.carga)}" style="padding: 4px 12px; border-radius: 20px; font-weight: 600;">
                                ‚öñÔ∏è ${escapeHTML(infoExtendida.carga)}
                            </span>
                        </p>
                    </div>
                    <div class="info-item">
                        <h4>Gasto Econ√≥mico</h4>
                        <p>
                            <span class="${getIndicatorClass(infoExtendida.gasto)}" style="padding: 4px 12px; border-radius: 20px; font-weight: 600;">
                                üí∞ ${escapeHTML(infoExtendida.gasto)}
                            </span>
                        </p>
                    </div>
                    <div class="info-item">
                        <h4>Tipo de Evaluaci√≥n</h4>
                        <p>${escapeHTML(infoExtendida.tipoEvaluacion)}</p>
                    </div>
                </div>
            </div>
    `;
    
    // Secci√≥n de comentarios
    if (comentarios.length > 0) {
        html += `
            <div class="comentarios-section">
                <div class="comentarios-header">
                    <h3>üí¨ Comentarios de estudiantes (${comentarios.length})</h3>
                    <button class="btn-toggle-comentarios" onclick="toggleComentarios()">
                        Mostrar comentarios
                    </button>
                </div>
                <div class="comentarios-container" id="comentariosContainer">
        `;
        
        comentarios.forEach((comentario, index) => {
            html += `
                <div class="comentario">
                    <div class="comentario-texto">
                        ${escapeHTML(comentario.texto)}
                    </div>
                    ${comentario.fecha ? `
                        <div class="comentario-fecha">
                            ${escapeHTML(comentario.fecha)}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="sin-datos">
                <div class="icono">üí¨</div>
                <h3>No hay comentarios escritos</h3>
                <p>S√© el primero en compartir tu experiencia con esta asignatura</p>
                <a class="btn-opinar" target="_blank" 
                   href="https://sandres0228.github.io/Opinionmaterias-Artesunalmed/"
                   style="margin-top: 16px; display: inline-block;">
                   üìù Compartir mi opini√≥n
                </a>
            </div>
        `;
    }
    
    html += `</div>`;
    
    document.getElementById('contenidoPerfil').innerHTML = html;
}

function verPerfilDocente(nombreDocente) {
    vista = "docente";
    mostrarSeccion('perfil');
    
    // Buscar todos los registros de este docente
    const registros = datos.filter(fila => 
        fila.Docente && normalizar(fila.Docente) === normalizar(nombreDocente)
    );
    
    // Calificaciones (incluyendo talleres)
    const calificaciones = registros
        .map(fila => parseFloat(fila["Valoraci√≥n Docente"]))
        .filter(calif => !isNaN(calif) && calif > 0);
    
    // Materias asociadas (excluyendo talleres y duplicados)
    const materiasAsociadas = [...new Set(registros
        .map(fila => fila.Asignatura)
        .filter(asignatura => asignatura && !esTaller(asignatura))
    )];
    
    // Comentarios (con informaci√≥n de origen)
    const comentarios = registros
        .filter(fila => fila["Opini√≥n Docente"] && fila["Opini√≥n Docente"].trim())
        .map(fila => {
            const esDeTaller = esTaller(fila.Asignatura || '');
            let origen = '';
            
            if (esDeTaller) {
                const match = fila.Asignatura.match(/Taller (II|III|IV|V|VI|VII)/i);
                origen = match ? `Taller ${match[1]}` : 'Taller';
            } else if (fila.Asignatura) {
                origen = fila.Asignatura;
            }
            
            return {
                texto: fila["Opini√≥n Docente"],
                fecha: fila.Timestamp || '',
                origen: origen
            };
        });
    
    const promedio = calcularPromedio(calificaciones);
    const numOpiniones = calificaciones.length;
    
    // Generar HTML del perfil
    let html = `
        <div class="perfil">
            <div class="perfil-header">
                <h2>üë®‚Äçüè´ ${escapeHTML(nombreDocente)}</h2>
                <div class="perfil-subtitle">Docente ‚Ä¢ ${numOpiniones} ${numOpiniones === 1 ? 'evaluaci√≥n' : 'evaluaciones'} de ${registros.length} registros</div>
            </div>
            
            <div class="calificacion">
                <div class="rating-container">
                    <div class="promedio-numero">${promedio.toFixed(1)}</div>
                    <div class="rating-info">
                        <div class="estrellas-promedio">
                            ${generarEstrellas(promedio)}
                        </div>
                        <div class="total-opiniones">
                            Basado en ${numOpiniones} ${numOpiniones === 1 ? 'evaluaci√≥n' : 'evaluaciones'} (incluyendo talleres)
                        </div>
                    </div>
                </div>
            </div>
    `;
    
    // Materias asociadas
    if (materiasAsociadas.length > 0) {
        html += `
            <div class="materias-asociadas">
                <h3 style="margin-bottom: 12px; color: var(--primary-color); font-size: 1.1rem;">üìö Materias asociadas</h3>
                <div class="materias-list">
        `;
        
        materiasAsociadas.forEach(materia => {
            html += `<span class="materia-tag">${escapeHTML(materia)}</span>`;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // Secci√≥n de comentarios
    if (comentarios.length > 0) {
        html += `
            <div class="comentarios-section">
                <div class="comentarios-header">
                    <h3>üí¨ Comentarios de estudiantes (${comentarios.length})</h3>
                    <button class="btn-toggle-comentarios" onclick="toggleComentarios()">
                        Mostrar comentarios
                    </button>
                </div>
                <div class="comentarios-container" id="comentariosContainer">
        `;
        
        comentarios.forEach(comentario => {
            html += `
                <div class="comentario">
                    <div class="comentario-header">
                        ${comentario.origen ? `
                            <span class="comentario-origen">${escapeHTML(comentario.origen)}</span>
                        ` : ''}
                        ${comentario.fecha ? `
                            <div class="comentario-fecha">${escapeHTML(comentario.fecha)}</div>
                        ` : ''}
                    </div>
                    <div class="comentario-texto">
                        ${escapeHTML(comentario.texto)}
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="sin-datos">
                <div class="icono">üí¨</div>
                <h3>No hay comentarios escritos</h3>
                <p>Este docente a√∫n no tiene comentarios de estudiantes</p>
            </div>
        `;
    }
    
    html += `</div>`;
    
    document.getElementById('contenidoPerfil').innerHTML = html;
}

// ================= FUNCIONES AUXILIARES =================
function toggleComentarios() {
    const container = document.getElementById('comentariosContainer');
    const button = document.querySelector('.btn-toggle-comentarios');
    
    if (container.classList.contains('visible')) {
        container.classList.remove('visible');
        button.textContent = 'Mostrar comentarios';
    } else {
        container.classList.add('visible');
        button.textContent = 'Ocultar comentarios';
    }
}

function mostrarError(mensaje) {
    const container = document.getElementById('contenidoPerfil');
    container.innerHTML = `
        <div class="sin-datos">
            <div class="icono">‚ö†Ô∏è</div>
            <h3>Error</h3>
            <p>${mensaje}</p>
            <button class="btn-volver" onclick="volver()" style="margin-top: 16px;">
                ‚Üê Volver al inicio
            </button>
        </div>
    `;
}

// ================= INICIALIZACI√ìN =================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Aplicaci√≥n de encuestas acad√©micas iniciada');
    cargarDatos();
    
    // Configurar b√∫squeda con debounce
    const buscador = document.getElementById('buscar');
    buscador.addEventListener('input', filtrar);
});

// ================= FUNCIONES GLOBALES =================
// Hacer funciones disponibles globalmente
window.verAsignaturas = verAsignaturas;
window.verDocentes = verDocentes;
window.volver = volver;
window.volverPerfil = volverPerfil;
window.filtrar = filtrar;
window.cambiarFiltro = cambiarFiltro;
window.toggleComentarios = toggleComentarios;
window.verPerfilAsignatura = verPerfilAsignatura;
window.verPerfilDocente = verPerfilDocente;
</script>

</body>
</html>
